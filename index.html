    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MASTER CODER'S FIX: DIRECT INJECTION OF FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",           // <--- REPLACE with your apiKey
            authDomain: "YOUR_AUTH_DOMAIN_HERE",   // <--- REPLACE with your authDomain
            projectId: "YOUR_PROJECT_ID_HERE",     // <--- REPLACE with your projectId
            storageBucket: "YOUR_STORAGE_BUCKET_HERE", // <--- REPLACE
            messagingSenderId: "YOUR_SENDER_ID_HERE",  // <--- REPLACE
            appId: "YOUR_APP_ID_HERE"              // <--- REPLACE with your appId
        };
        const appId = firebaseConfig.appId; // Use the configured appId
        const initialAuthToken = null; // Token not needed for anonymous sign-in

        let db;
        let auth;
        let userId = null;

        const form = document.getElementById('membershipApplicationForm');
        const messageBox = document.getElementById('messageBox');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');
        
        let isAuthReady = false;

        async function initFirebase() {
            try {
                // Check if we have enough config to proceed
                if (!firebaseConfig.apiKey) {
                    // This error will only trigger if you failed to put your actual keys above!
                    throw new Error("Firebase configuration is missing or invalid in the HTML file.");
                }

                // 1. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Set to 'error' or 'silent' for production
                
                await setPersistence(auth, browserSessionPersistence);
                
                // 2. Authenticate User (Anonymous sign-in for public forms)
                // Note: Removed signInWithCustomToken since we only use anonymous for this public form
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized. User ID:", userId);
                        statusMessage.classList.add('hidden'); // Hide status message
                        form.classList.remove('hidden'); // Show the form
                        submitButton.disabled = false;
                        isAuthReady = true;
                    } else {
                        console.error("Authentication failed. Cannot get user ID.");
                        statusMessage.textContent = 'ERROR: Authentication failed. Please refresh the page.';
                        statusMessage.classList.remove('text-indigo-600', 'border-indigo-300');
                        statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                        submitButton.disabled = true;
                    }
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessage.textContent = `FATAL ERROR: Database connection failed. Details: ${error.message}`;
                statusMessage.classList.remove('text-indigo-600', 'border-indigo-300');
                statusMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                form.classList.add('hidden'); // Ensure form remains hidden on error
                submitButton.disabled = true;
            }
        }
        
        // ... (rest of your functions: validateForm, saveApplication, form.addEventListener) ...
        
        function validateForm() {
            // This function exists for non-native validation checks (like checking if a radio button group is selected)
            // Native HTML5 validation will handle required inputs.
            const maritalStatusRadios = document.getElementsByName('maritalStatus');
            const isMaritalStatusSelected = Array.from(maritalStatusRadios).some(radio => radio.checked);
            
            if (!isMaritalStatusSelected) {
                // Highlight marital status section if missing, but primarily rely on browser validation
                return false;
            }
            return true;
        }

        async function saveApplication(data) {
            if (!db || !userId) {
                return { success: false, error: "Database not ready. Please wait for initialization." };
            }
            
            try {
                // Public Collection: /artifacts/{appId}/public/data/applications
                const collectionPath = `/artifacts/${appId}/public/data/applications`;
                
                // Create a clean document ID using the applicant's name and a timestamp
                const docId = `${data.printName.replace(/[^a-zA-Z0-9]/g, '').slice(0, 30)}-${Date.now()}`;
                const docRef = doc(collection(db, collectionPath), docId);

                await setDoc(docRef, {
                    ...data,
                    applicantId: userId,
                    submissionDate: new Date().toISOString()
                });

                console.log("Document successfully written with ID:", docRef.id);
                return { success: true };

            } catch (e) {
                console.error("Error adding document: ", e);
                return { success: false, error: e.message };
            }
        }

        form.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            if (!isAuthReady) {
                 messageBox.className = 'mt-6 p-4 text-center text-sm rounded-lg bg-red-100 text-red-700';
                 messageBox.textContent = 'Please wait for the database connection to initialize.';
                 messageBox.classList.remove('hidden');
                 return;
            }

            // 1. Validation Check
            if (!form.checkValidity() || !validateForm()) {
                messageBox.className = 'mt-6 p-4 text-center text-sm rounded-lg bg-red-100 text-red-700';
                messageBox.textContent = 'Please fill out all required fields.';
                messageBox.classList.remove('hidden');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
            messageBox.classList.add('hidden');

            // 2. Prepare Data
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // 3. Save to Firestore
            const result = await saveApplication(data);

            // 4. Handle Result
            if (result.success) {
                messageBox.className = 'mt-6 p-4 text-center text-sm rounded-lg bg-green-100 text-green-700';
                messageBox.textContent = 'Success! Your application has been submitted and saved to the database.';
                form.reset(); // Clear the form after success
            } else {
                messageBox.className = 'mt-6 p-4 text-center text-sm rounded-lg bg-red-100 text-red-700';
                messageBox.textContent = `Submission failed: ${result.error}. Please try again.`;
            }
            
            messageBox.classList.remove('hidden');
            submitButton.textContent = 'Save & Submit Application';
            submitButton.disabled = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Start initialization when the page loads
        initFirebase();
    </script>
