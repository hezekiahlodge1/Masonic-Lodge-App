<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Hezekiah Lodge Application for Membership</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Deep Blue and Gold Theme --- */
        :root {
            --color-primary: #00284D; /* Deep Blue */
            --color-accent: #DAA520; /* Goldenrod/Gold */
            --color-background: #f0f4f8; /* Light gray-blue background */
        }
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
        }
        
        /* Header Styling */
        .header-block {
            background-color: var(--color-primary);
            color: white;
            border-bottom: 5px solid var(--color-accent);
            border-radius: 0.75rem 0.75rem 0 0; 
        }
        .header-block h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
        }
        .hammer-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            color: var(--color-accent);
            text-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
        }

        /* Form Element Styling */
        .section-header {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
        }
        .input-field {
            border: 1px solid #c8d2e0; 
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            background-color: #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            border-color: var(--color-accent); 
            box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.3);
            outline: none;
        }
        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: block;
            line-height: 1.5;
        }

        /* Submit Button Styling */
        .btn-submit {
            background-color: var(--color-accent);
            color: var(--color-primary);
            font-weight: 700;
            border: 2px solid var(--color-accent);
            transition: background-color 0.3s, opacity 0.3s, transform 0.2s;
        }
        .btn-submit:hover {
            background-color: #e0b445;
            transform: scale(1.02);
        }
        .btn-submit:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Message Box Styling */
        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            padding: 1rem;
            border: 1px dashed var(--color-accent);
            border-radius: 0.5rem;
            background-color: #fcf8e3;
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b988;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        /* --- Admin Overlay Styling --- */
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 50; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .admin-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 950px; /* Wider for list */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            color: var(--color-primary);
            border: 5px solid var(--color-accent);
        }
        .admin-content h2 {
            font-family: 'Playfair Display', serif;
            color: var(--color-primary);
        }
        .btn-close {
            background-color: var(--color-primary);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-close:hover {
            background-color: #004080;
        }
        /* Admin Button Style */
        .btn-admin {
            background-color: var(--color-accent);
            color: var(--color-primary);
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-admin:hover {
            background-color: #e0b445;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="adminPasswordModal" class="admin-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-80 max-w-full text-center border-4 border-yellow-600">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Admin Login</h3>
            <p class="text-sm text-gray-600 mb-4">Enter the administrative passcode:</p>
            <input type="password" id="adminPasscodeField" class="input-field mb-4 text-center" placeholder="Passcode (Hint: 1776)">
            <button id="adminPasscodeSubmit" class="w-full px-4 py-2 rounded-lg btn-submit">
                Access Dashboard
            </button>
            <button id="adminPasscodeCancel" class="w-full px-4 py-1 mt-2 rounded-lg text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition">
                Cancel
            </button>
            <p id="passcodeError" class="text-xs text-red-500 mt-2 hidden">Invalid passcode. Try again.</p>
        </div>
    </div>


    <div id="adminPageOverlay" class="admin-overlay hidden">
        <div class="admin-content">
            <h2 class="text-3xl font-bold mb-4 border-b pb-2 border-gray-300">Admin Dashboard: Submitted Applications</h2>
            <p class="mb-4 text-gray-700 font-semibold text-sm">Live applications submitted to the `applications` collection. User ID: <span id="adminUserId" class="font-mono text-xs"></span></p>
            
            <div id="adminLoadStatus" class="p-3 mb-4 rounded-lg text-sm bg-blue-100 text-blue-800">Loading applications...</div>

            <section id="applicationsList" class="max-h-[60vh] overflow-y-auto space-y-4 pr-2"></section>

            <div class="flex justify-end mt-8">
                <button id="closeAdminButton" class="btn-close px-6 py-2 rounded-lg shadow-lg">Close Admin</button>
            </div>
        </div>
    </div>


    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl">
        
        <header class="header-block p-6 sm:p-8 relative">
            <button id="adminButton" class="btn-admin absolute top-4 right-4 text-sm shadow-md">
                Admin
            </button>
            
            <div class="text-center">
                <span class="hammer-icon">&#9874;</span>
                <h1 class="font-extrabold tracking-tight">APPLICATION FOR MEMBERSHIP</h1>
                <p class="text-xl mt-1 font-bold text-gray-200">King Hezekiah Lodge No. 1</p>
                <p class="text-sm mt-2 text-gray-400">A. F. & A. M. of Texas and the U. S. A.</p>
                <p class="text-xs text-gray-500 mt-1">Ancient Free and Accepted Scottish Rite / York Rite / Member of the General Grand Masonic Congress</p>
            </div>
        </header>

        <div class="p-6 sm:p-10">
            <div id="statusMessage" class="text-center p-4 text-white font-medium bg-gray-600 rounded-lg mb-8">
                Initializing secure connection...
            </div>
            
            <div id="errorDisplay" class="hidden mb-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                <p class="font-bold">Connection Error</p>
                <p id="errorText">Something went wrong.</p>
            </div>

            <form id="membershipApplicationForm" class="space-y-10 hidden">
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Lodge Information</h2>
                    <div class="form-group">
                        <label for="lodgeName">IN Lodge Name</label>
                        <input type="text" id="lodgeName" name="lodgeName" placeholder="Name of Lodge" class="input-field" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="lodgeNumber">Lodge No.</label>
                            <input type="text" id="lodgeNumber" name="lodgeNumber" placeholder="Lodge Number" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="applicationDate">Date of Application given (Month/Day/Year)</label>
                            <input type="date" id="applicationDate" name="applicationDate" class="input-field" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group md:col-span-2">
                            <label for="lodgeAddress">Address</label>
                            <input type="text" id="lodgeAddress" name="lodgeAddress" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeCity">City</label>
                            <input type="text" id="lodgeCity" name="lodgeCity" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeCounty">County of</label>
                            <input type="text" id="lodgeCounty" name="lodgeCounty" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeState">State</label>
                            <input type="text" id="lodgeState" name="lodgeState" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeZip">Zip Code</label>
                            <input type="text" id="lodgeZip" name="lodgeZip" class="input-field">
                        </div>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Recommendations & Lodge Contact</h2>
                    <p class="font-semibold text-gray-700">Recommended By (Four Brother's Names and Addresses):</p>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec1Name" name="rec1Name" class="input-field" placeholder="Brother's Name 1" required>
                            <input type="text" id="rec1Address" name="rec1Address" class="input-field" placeholder="Address / City/State/ZIP 1" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec2Name" name="rec2Name" class="input-field" placeholder="Brother's Name 2" required>
                            <input type="text" id="rec2Address" name="rec2Address" class="input-field" placeholder="Address / City/State/ZIP 2" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec3Name" name="rec3Name" class="input-field" placeholder="Brother's Name 3" required>
                            <input type="text" id="rec3Address" name="rec3Address" class="input-field" placeholder="Address / City/State/ZIP 3" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec4Name" name="rec4Name" class="input-field" placeholder="Brother's Name 4" required>
                            <input type="text" id="rec4Address" name="rec4Address" class="input-field" placeholder="Address / City/State/ZIP 4" required>
                        </div>
                    </div>

                    <div class="space-y-4 pt-4 border-t border-gray-200">
                        <div class="form-group">
                            <label for="wmSecretaryName">Name of W.M. or Secretary</label>
                            <input type="text" id="wmSecretaryName" name="wmSecretaryName" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="wmSecretaryAddress">Address, City/State/ZIP</label>
                            <input type="text" id="wmSecretaryAddress" name="wmSecretaryAddress" placeholder="Address, City/State/ZIP" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="wmSecretaryPhone">Telephone No. (A/C)</label>
                            <input type="tel" id="wmSecretaryPhone" name="wmSecretaryPhone" class="input-field">
                        </div>
                    </div>
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Applicant Personal Details</h2>
                    <p class="disclaimer">All applicants to join the order shall be required to fill in the application and take a background check in their own handwriting, or cause the same to be done over their signature.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="printName">Applicant Name (PRINT OR TYPE NAME)</label>
                            <input type="text" id="printName" name="printName" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="ssn">Social Security No.</label>
                            <input type="text" id="ssn" name="ssn" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="age">Age last birthday</label>
                            <input type="number" id="age" name="age" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth</label>
                            <input type="date" id="dob" name="dob" class="input-field">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="streetAddress">Street Address</label>
                        <input type="text" id="streetAddress" name="streetAddress" class="input-field">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="form-group">
                            <label for="applicantCity">City</label>
                            <input type="text" id="applicantCity" name="applicantCity" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="applicantState">State</label>
                            <input type="text" id="applicantState" name="applicantState" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="applicantZip">Zip Code</label>
                            <input type="text" id="applicantZip" name="applicantZip" class="input-field">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicantPhone">Telephone No. (A/C)</label>
                        <input type="tel" id="applicantPhone" name="applicantPhone" class="input-field">
                    </div>
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Marital and Family Status</h2>
                    <div class="form-group space-y-2">
                        <label>2. Marital Status</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="married" class="form-radio text-blue-600">
                                <span class="ml-2">Married</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="single" class="form-radio text-blue-600">
                                <span class="ml-2">Single</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="widowed" class="form-radio text-blue-600">
                                <span class="ml-2">Widowed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="divorced" class="form-radio text-blue-600">
                                <span class="ml-2">Divorced</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">(a) If Married:</h3>
                        <div class="form-group">
                            <label for="wifeName">Name of Wife</label>
                            <input type="text" id="wifeName" name="wifeName" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="marriageDetails">Date and place of marriage</label>
                            <input type="text" id="marriageDetails" name="marriageDetails" placeholder="Date and City/State" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="childrenMarried">Names and ages of all children born to this marriage:</label>
                            <textarea id="childrenMarried" name="childrenMarried" rows="2" class="input-field resize-none"></textarea>
                        </div>
                    </div>

                    <div class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">(b) If married more than once:</h3>
                        
                        <div class="form-group space-y-2">
                            <label>State how said marriage terminated (Divorce or Death)</label>
                            <input type="text" id="priorMarriageTerminationDetails" name="priorMarriageTerminationDetails" class="input-field" placeholder="e.g., Divorce, Death">
                        </div>

                        <div class="form-group">
                            <label for="priorWifeChildren">Names and ages of all children born to this marriage:</label>
                            <textarea id="priorWifeChildren" name="priorWifeChildren" rows="2" class="input-field resize-none"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="deceasedWifeName">If terminated in death, Name of Deceased Wife</label>
                                <input type="text" id="deceasedWifeName" name="deceasedWifeName" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorcedWifeName">If terminated by divorce, name of Divorced wife</label>
                                <input type="text" id="divorcedWifeName" name="divorcedWifeName" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorceDate">Date Divorce granted</label>
                            <input type="date" id="divorceDate" name="divorceDate" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorceCityState">City, State of divorce</label>
                                <input type="text" id="divorceCityState" name="divorceCityState" class="input-field" placeholder="City, State">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="motherName">Name of Mother</label>
                            <input type="text" id="motherName" name="motherName" class="input-field">
                            <label class="inline-flex items-center mt-2">
                                <input type="checkbox" name="motherDeceased" value="true" class="form-checkbox text-red-600 rounded">
                                <span class="ml-2 text-sm text-red-700">Deceased (Check if applicable)</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="fatherName">Name of Father</label>
                            <input type="text" id="fatherName" name="fatherName" class="input-field">
                            <label class="inline-flex items-center mt-2">
                                <input type="checkbox" name="fatherDeceased" value="true" class="form-checkbox text-red-600 rounded">
                                <span class="ml-2 text-sm text-red-700">Deceased (Check if applicable)</span>
                            </label>
                        </div>
                        <div class="form-group md:col-span-2">
                            <label for="parentsAddress">Address (if living)</label>
                            <input type="text" id="parentsAddress" name="parentsAddress" placeholder="Address of Mother or Father" class="input-field">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="siblings">Names of all brothers and sisters of applicant born of same parents (list names/ages):</label>
                        <textarea id="siblings" name="siblings" rows="3" class="input-field resize-none"></textarea>
                    </div>

                    <div class="form-group border-t pt-4 border-gray-200">
                        <label for="beneficiaryName">Beneficiary‚Äôs Name and Relationship</label>
                        <input type="text" id="beneficiaryName" name="beneficiaryName" placeholder="Name - Relationship" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="beneficiaryAddress">Beneficiary's Address</label>
                        <input type="text" id="beneficiaryAddress" name="beneficiaryAddress" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="beneficiaryCityStateZip">City/State/Zip</label>
                        <input type="text" id="beneficiaryCityStateZip" name="beneficiaryCityStateZip" class="input-field">
                    </div>
                    
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Employment and Prior Membership</h2>
                    <div class="form-group">
                        <label for="occupation">Occupation</label>
                        <input type="text" id="occupation" name="occupation" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="employer">Name and address of employer</label>
                        <input type="text" id="employer" name="employer" class="input-field">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="employmentLength">How long in present employment?</label>
                            <input type="text" id="employmentLength" name="employmentLength" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="priorEmployer">Prior employer</label>
                            <input type="text" id="priorEmployer" name="priorEmployer" class="input-field">
                        </div>
                    </div>
                    <div class="form-group pt-4 border-t border-gray-200">
                        <label class="block mb-2">Have you ever made application to join a Masonic Lodge before?</label>
                        <div class="flex gap-4 mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="previousApplication" value="yes" class="form-radio text-blue-600">
                                <span class="ml-2">YES</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="previousApplication" value="no" class="form-radio text-blue-600">
                                <span class="ml-2">NO</span>
                            </label>
                        </div>
                        <div class="space-y-4 p-4 rounded-lg bg-gray-50">
                            <h3 class="font-semibold text-base text-gray-700">(a) If YES:</h3>
                            <div class="form-group">
                                <label for="priorLodgeName">Give name, City, State and Date of application</label>
                                <input type="text" id="priorLodgeName" name="priorLodgeName" placeholder="Name, City, State - Year" class="input-field">
                            </div>
                        </div>
                        <div class="space-y-4 p-4 rounded-lg bg-gray-50 mt-4">
                            <h3 class="font-semibold text-base text-gray-700">(b) If reinstating:</h3>
                            <div class="form-group">
                                <label for="reinstatingLodge">Name and No. of the Lodge where membership last held</label>
                                <input type="text" id="reinstatingLodge" name="reinstatingLodge" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="terminationDate">Date membership in said Lodge terminated</label>
                                <input type="date" id="terminationDate" name="terminationDate" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="terminationReason">Why Terminated</label>
                                <input type="text" id="terminationReason" name="terminationReason" class="input-field">
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Health and Conduct</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="healthStatus">Are you in good health?</label>
                            <select id="healthStatus" name="healthStatus" class="input-field appearance-none bg-white">
                                <option value="yes">YES</option>
                                <option value="no">NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prescriptionTreatment">Has any physician prescribed treatment for you in last two years?</label>
                            <select id="prescriptionTreatment" name="prescriptionTreatment" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-base text-gray-700">If YES to prescribed treatment:</h3>
                        <div class="form-group">
                            <label for="physicianDetails">Name and address of physician</label>
                            <input type="text" id="physicianDetails" name="physicianDetails" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="treatmentReason">For what treated?</label>
                            <input type="text" id="treatmentReason" name="treatmentReason" class="input-field">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="alcoholUse">Do you use alcoholic liquors to excess?</label>
                            <select id="alcoholUse" name="alcoholUse" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="drugUse">Narcotics or other drugs?</label>
                            <select id="drugUse" name="drugUse" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="convictedCrime">Have you ever been convicted of a crime or felony?</label>
                        <select id="convictedCrime" name="convictedCrime" class="input-field appearance-none bg-white">
                            <option value="no">NO</option>
                            <option value="yes">YES</option>
                        </select>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Non-Masonic References</h2>
                    <p class="font-semibold text-gray-700">Please provide three non-Masonic references:</p>
                    <div class="space-y-4">
                        <div class="form-group">
                            <label for="reference1">1. Reference Name & Contact</label>
                            <input type="text" id="reference1" name="reference1" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="reference2">2. Reference Name & Contact</label>
                            <input type="text" id="reference2" name="reference2" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="reference3">3. Reference Name & Contact</label>
                            <input type="text" id="reference3" name="reference3" class="input-field" required>
                        </div>
                    </div>
                </section>

                <section class="space-y-6 pt-6 border-t border-gray-200">
                    <h2 class="text-xl font-bold section-header">Applicant Covenant</h2>
                    
                    <div class="disclaimer text-sm text-gray-600">
                        I certify and warrant the above answers to be true and correct, and agree that the same shall form a part of my application for membership... and I further covenant and agree that in the event any of my answers given above prove to be false or untrue, neither I, my beneficiary, heirs nor legal representatives shall ever assert any claim to the relief benefits provided for by the Order. And the liability of the Society shall be limited to refund of the relief assessments actually paid in by me.
                    </div>

                    <div class="form-group">
                        <label for="signatureApplicant">Signature of Applicant (Type full name to sign)</label>
                        <input type="text" id="signatureApplicant" name="signatureApplicant" class="input-field font-serif text-lg italic" required>
                    </div>
                </section>

                <div class="flex flex-col items-center pt-8 gap-4">
                    <button type="submit" id="submitButton" class="w-full sm:w-1/2 px-8 py-4 rounded-lg shadow-xl btn-submit tracking-wider disabled:opacity-50" disabled>
                        Save & Submit Formal Application
                    </button>
                    <div id="spinner" class="hidden font-bold">
                        <svg class="animate-spin h-5 w-5 text-current inline mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </div>
                </div>

                <div id="messageBox" class="hidden mt-6 p-4 text-center text-sm rounded-lg" role="alert"></div>

            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug to see detailed console output
        setLogLevel('Debug');

        // =========================================================================================
        // LIVE FIREBASE CONFIGURATION (Provided by User)
        // =========================================================================================
        const YOUR_EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBAYN5FX3snNSLDjcxnjT1PNC33Qu5TlWo",
            authDomain: "hezekiah-lodge-admin.firebaseapp.com",
            projectId: "hezekiah-lodge-admin",
            storageBucket: "hezekiah-lodge-admin.firebasestorage.app",
            messagingSenderId: "599617453177",
            appId: "1:599617453177:web:7ff088d9ac115427aca8a8",
            measurementId: "G-BZB6H3N8ZZ" 
        };
        // =========================================================================================

        // --- ADMIN CONFIGURATION ---
        const ADMIN_PASSCODE = '1776'; 
        // --- END ADMIN CONFIGURATION ---


        let db, auth;
        let userId = null;
        let isDatabaseActive = false;
        
        // UI Elements
        const form = document.getElementById('membershipApplicationForm');
        const statusMessage = document.getElementById('statusMessage');
        const errorDisplay = document.getElementById('errorDisplay');
        const submitButton = document.getElementById('submitButton');
        const spinner = document.getElementById('spinner');
        const messageBox = document.getElementById('messageBox');
        const adminButton = document.getElementById('adminButton');
        
        // Admin Dashboard Elements
        const adminPageOverlay = document.getElementById('adminPageOverlay');
        const closeAdminButton = document.getElementById('closeAdminButton');
        const adminLoadStatus = document.getElementById('adminLoadStatus');
        const applicationsList = document.getElementById('applicationsList');
        const adminUserIdSpan = document.getElementById('adminUserId');

        // Admin Password Modal Elements (NEW)
        const adminPasswordModal = document.getElementById('adminPasswordModal');
        const adminPasscodeField = document.getElementById('adminPasscodeField');
        const adminPasscodeSubmit = document.getElementById('adminPasscodeSubmit');
        const adminPasscodeCancel = document.getElementById('adminPasscodeCancel');
        const passcodeError = document.getElementById('passcodeError');


        // --- Configuration Handling ---
        // Canvas environment variables take precedence if they exist
        const isCanvasMode = typeof __firebase_config !== 'undefined' && __firebase_config.length > 0;
        let config;
        let globalAppId = 'hezekiah-lodge-admin'; // Use the user's projectId as the default app ID

        if (isCanvasMode) {
            config = JSON.parse(__firebase_config);
            globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id';
            isDatabaseActive = true; 
        } else {
            config = YOUR_EXTERNAL_FIREBASE_CONFIG;
            globalAppId = config.projectId; 
            
            // Assume database is active since user provided credentials
            if (config.apiKey && config.projectId && config.projectId.length > 5) {
                 isDatabaseActive = true;
            } else {
                 isDatabaseActive = false;
            }
        }
        
        /**
         * Initializes Firebase services and authentication.
         */
        async function initFirebase() {
            try {
                if (!isDatabaseActive) {
                    throw new Error("Initialization Failed: Configuration missing or invalid.");
                }

                // 2. Initialize services
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);

                let userCredential;

                // 3. Authenticate
                if (isCanvasMode && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Sign in anonymously for public app usage
                    userCredential = await signInAnonymously(auth);
                }

                if (userCredential && userCredential.user && userCredential.user.uid) {
                    userId = userCredential.user.uid;
                    
                    // SUCCESS STATE
                    statusMessage.textContent = `Connected LIVE (User ID: ${userId.substring(0, 8)}...). Submissions will be saved to Firestore.`;
                    statusMessage.classList.remove('bg-gray-600', 'message-box-error');
                    statusMessage.classList.add('message-box-success');
                    
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                        form.classList.remove('hidden');
                        submitButton.disabled = false;
                    }, 500); 
                } else {
                    throw new Error("Authentication failed: Unable to establish user session.");
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                
                let friendlyError = isDatabaseActive ? `Connection Error: ${error.message}. Please check your Firebase rules.` : 
                    "‚ö†Ô∏è CONFIGURATION ERROR: The application cannot connect to the database.";

                statusMessage.classList.remove('bg-gray-600', 'message-box-success');
                statusMessage.classList.add('message-box-error');
                statusMessage.textContent = friendlyError;
                
                // Keep the form hidden if connection truly failed, or show it for MOCK purposes
                form.classList.remove('hidden');
                submitButton.disabled = true;
                isDatabaseActive = false;
            }
        }
        
        /**
         * Renders a single application card for the admin view.
         * @param {Object} appData - The application data object from Firestore.
         * @param {string} docId - The document ID.
         * @returns {HTMLElement} The card element.
         */
        function renderApplication(appData, docId) {
            const date = appData.submissionDate?.toDate ? appData.submissionDate.toDate().toLocaleString() : 'N/A';
            
            const card = document.createElement('div');
            card.className = 'border border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 bg-white';
            card.setAttribute('data-doc-id', docId); // For potential future detail lookup
            
            const requiredFields = [
                { label: 'Name', key: 'printName' },
                { label: 'Lodge Name', key: 'lodgeName' },
                { label: 'Lodge No.', key: 'lodgeNumber' },
                { label: 'Application Date', key: 'applicationDate' },
            ];
            
            let content = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 border-b pb-2">
                    <h4 class="font-bold text-lg text-primary">${appData.printName || 'Applicant'}</h4>
                    <span class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded mt-1 sm:mt-0">ID: ${docId.substring(0, 8)}...</span>
                </div>
                <div class="text-sm space-y-1 grid grid-cols-2 md:grid-cols-4 gap-2">
                    <p class="col-span-2 md:col-span-1"><strong>Status:</strong> <span class="text-green-600 font-semibold">${appData.status}</span></p>
                    <p class="col-span-2 md:col-span-1"><strong>Submitted:</strong> ${date}</p>
                    ${requiredFields.map(field => 
                        `<p class="col-span-2 md:col-span-1 truncate" title="${appData[field.key] || 'Not Provided'}"><strong>${field.label}:</strong> ${appData[field.key] || 'N/A'}</p>`
                    ).join('')}
                    <div class="col-span-full pt-2 flex flex-wrap gap-2">
                         <button class="btn-admin px-3 py-1 text-xs bg-gray-300 text-gray-800 hover:bg-gray-400" onclick="viewDetails('${docId}')">View Full Details</button>
                         <button class="btn-admin px-3 py-1 text-xs bg-green-500 text-white hover:bg-green-600" onclick="downloadApplication('${docId}')">üì• Download</button>
                         <button class="btn-admin px-3 py-1 text-xs bg-red-500 text-white hover:bg-red-600" onclick="deleteApplication('${docId}', '${appData.printName || 'Application'}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;

            card.innerHTML = content;
            return card;
        }

        /**
         * Loads and listens for real-time changes to the applications collection.
         */
        function loadApplications() {
            if (!db || !userId) {
                adminLoadStatus.textContent = "Database not connected or user not authenticated.";
                adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm message-box-error';
                return;
            }
            
            adminUserIdSpan.textContent = userId;
            applicationsList.innerHTML = '';
            adminLoadStatus.textContent = "Fetching real-time applications...";
            adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm bg-blue-100 text-blue-800';

            const collectionPath = `/artifacts/${globalAppId}/public/data/applications`;
            const q = query(collection(db, collectionPath));
            
            // onSnapshot listener for real-time updates
            onSnapshot(q, (snapshot) => {
                applicationsList.innerHTML = ''; // Clear existing list
                const applications = [];

                snapshot.forEach(doc => {
                    applications.push({ id: doc.id, ...doc.data() });
                });

                // Client-side sorting by submission date (descending - newest first)
                applications.sort((a, b) => {
                    const dateA = a.submissionDate?.toDate ? a.submissionDate.toDate().getTime() : 0;
                    const dateB = b.submissionDate?.toDate ? b.submissionDate.toDate().getTime() : 0;
                    return dateB - dateA; // Sort descending (newest first)
                });

                if (applications.length === 0) {
                    adminLoadStatus.textContent = "No applications submitted yet.";
                    adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm bg-yellow-100 text-yellow-800';
                    return;
                }

                applications.forEach(app => {
                    applicationsList.appendChild(renderApplication(app, app.id));
                });

                adminLoadStatus.textContent = `Found ${applications.length} applications. Showing real-time feed.`;
                adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm message-box-success';

            }, (error) => {
                console.error("Firestore Error in onSnapshot:", error);
                adminLoadStatus.textContent = `Error loading applications: ${error.message}`;
                adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm message-box-error';
            });
        }

        // --- NEW ADMIN FUNCTIONS ---

        /**
         * Simulates downloading the application data.
         * Note: Actual file creation/download requires server-side logic or a blob, 
         * but for this environment, we will use a friendly alert.
         * @param {string} docId - The ID of the document to download.
         */
        window.downloadApplication = function(docId) {
            const appCard = applicationsList.querySelector(`[data-doc-id="${docId}"]`);
            if (appCard) {
                // Change the button text/color briefly to give feedback
                const downloadBtn = appCard.querySelector('button[onclick*="downloadApplication"]');
                if (downloadBtn) {
                    const originalText = downloadBtn.innerHTML;
                    downloadBtn.innerHTML = '‚úÖ Processing...';
                    downloadBtn.disabled = true;

                    // Simulate the download process
                    setTimeout(() => {
                        // In a real app, you would fetch data, format it (e.g., to PDF/JSON), 
                        // and trigger the download.
                        const nameElement = appCard.querySelector('h4').textContent;
                        alert(`Download simulated for: ${nameElement} (ID: ${docId}). \n\nIn a live environment, a JSON/PDF file of the application data would now download.`);
                        
                        downloadBtn.innerHTML = originalText;
                        downloadBtn.disabled = false;
                    }, 1000);
                }
            } else {
                alert("Error: Application card not found for download.");
            }
        }

        /**
         * Deletes the application document from Firestore.
         * @param {string} docId - The ID of the document to delete.
         * @param {string} appName - The name of the applicant for confirmation.
         */
        window.deleteApplication = async function(docId, appName) {
            if (!confirm(`Are you sure you want to permanently DELETE the application for ${appName}? This action cannot be undone.`)) {
                return;
            }

            const appCard = applicationsList.querySelector(`[data-doc-id="${docId}"]`);
            const deleteBtn = appCard?.querySelector('button[onclick*="deleteApplication"]');
            
            if (deleteBtn) {
                deleteBtn.innerHTML = '‚ùå Deleting...';
                deleteBtn.disabled = true;
            }

            try {
                if (!db) {
                     throw new Error("Database is not connected.");
                }
                
                const collectionPath = `/artifacts/${globalAppId}/public/data/applications`;
                const docRef = doc(db, collectionPath, docId);
                
                await deleteDoc(docRef);

                // Note: The onSnapshot listener will automatically remove the card from the UI.
                // We show a temporary success message in the status area.
                adminLoadStatus.textContent = `‚úÖ Successfully deleted application for ${appName}.`;
                adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm message-box-error bg-red-100 text-red-800 border-red-500';
                
                setTimeout(() => {
                    loadApplications(); // Re-trigger load to reset status message
                }, 3000);

            } catch (error) {
                console.error("Error deleting document: ", error);
                alert(`Failed to delete application for ${appName}: ${error.message}.`);
                if (deleteBtn) {
                    deleteBtn.innerHTML = 'üóëÔ∏è Delete';
                    deleteBtn.disabled = false;
                }
            }
        }

        /**
         * Mocks the "View Full Details" functionality with a temporary message box.
         * @param {string} docId - The ID of the document to view.
         */
        window.viewDetails = function(docId) {
            // Since alert() and multiple files are restricted, we show a friendly message.
            const tempMsgBox = document.createElement('div');
            tempMsgBox.textContent = `Application ID: ${docId.substring(0, 8)}... - Feature Note: In a production environment, this button would open a detailed, full-screen modal showing the applicant's complete submission data in a readable format.`;
            tempMsgBox.className = "fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 rounded-lg shadow-lg bg-yellow-100 text-yellow-800 z-50 transition-opacity duration-300 w-11/12 md:w-1/2 text-center text-sm font-semibold border-2 border-yellow-300";
            document.body.appendChild(tempMsgBox);
            
            setTimeout(() => {
                tempMsgBox.classList.add('opacity-0');
                setTimeout(() => tempMsgBox.remove(), 300);
            }, 3000);
        }
        // --- END NEW ADMIN FUNCTIONS ---
        
        /**
         * Handles form submission
         */
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            messageBox.classList.add('hidden');
            if (!form.checkValidity()) {
                messageBox.textContent = "Please fill out all required fields.";
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-error block";
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            spinner.classList.remove('hidden');

            try {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                if (!isDatabaseActive) {
                    throw new Error("Cannot submit. Database is not active or initialized.");
                }
                
                // REAL SUBMISSION LOGIC
                data.applicantId = userId;
                data.submissionDate = serverTimestamp();
                data.appId = globalAppId; 
                data.status = 'Pending Review';

                // IMPORTANT: Saving to the public collection path defined by the Canvas security rules
                // /artifacts/{appId}/public/data/{your_collection_name}
                const collectionPath = `/artifacts/${globalAppId}/public/data/applications`;
                const collectionRef = collection(db, collectionPath);
                
                await addDoc(collectionRef, data);

                messageBox.textContent = 'Success! Your application has been submitted and saved to the database for review. Thank you.';
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-success block";
                form.reset();
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (e) {
                console.error("Error adding document: ", e);
                messageBox.textContent = `Submission failed: ${e.message}. Check your Firebase rules and console logs.`;
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-error block";
            } finally {
                submitButton.textContent = 'Save & Submit Formal Application';
                submitButton.disabled = false;
                spinner.classList.add('hidden');
            }
        });

        // --- ADMIN LOGIC (Refactored to use Custom Modal) ---

        /**
         * Core logic to handle admin login submission.
         */
        function handleAdminLogin() {
            const passcode = adminPasscodeField.value;
            passcodeError.classList.add('hidden');
            
            if (passcode === ADMIN_PASSCODE) {
                adminPasswordModal.classList.add('hidden'); // Hide password modal
                
                if (isDatabaseActive) {
                    loadApplications(); // Load data on successful login
                } else {
                    // Show the overlay even if not connected, but show an error message
                    adminLoadStatus.textContent = "Database connection failed during initialization. Cannot load live data.";
                    adminLoadStatus.className = 'p-3 mb-4 rounded-lg text-sm message-box-error';
                }
                adminPageOverlay.classList.remove('hidden'); // Show Admin Dashboard
            } else {
                passcodeError.textContent = "Invalid passcode. Try again.";
                passcodeError.classList.remove('hidden');
                adminPasscodeField.value = '';
                setTimeout(() => adminPasscodeField.focus(), 100);
            }
        }


        /**
         * Handles the Admin button click, showing the custom passcode modal.
         */
        adminButton.addEventListener('click', () => {
            // 1. Show the custom modal instead of prompt()
            adminPasscodeField.value = ''; // Clear previous input
            passcodeError.classList.add('hidden');
            adminPasswordModal.classList.remove('hidden');
            setTimeout(() => adminPasscodeField.focus(), 100);
        });

        /**
         * Event listener for the modal's submit button.
         */
        adminPasscodeSubmit.addEventListener('click', handleAdminLogin);

        /**
         * Event listener for pressing Enter in the passcode field.
         */
        adminPasscodeField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleAdminLogin();
            }
        });

        /**
         * Event listener for the modal's cancel button.
         */
        adminPasscodeCancel.addEventListener('click', () => {
            adminPasswordModal.classList.add('hidden');
        });


        /**
         * Closes the Admin page overlay.
         */
        closeAdminButton.addEventListener('click', () => {
            adminPageOverlay.classList.add('hidden');
            // Unsubscribe logic would go here if we stored the unsubscribe function globally.
        });


        // Start App
        window.onload = initFirebase;
    </script>
</body>
</html>
