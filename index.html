<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Hezekiah Lodge No. 1 Application for Membership</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Deep Blue and Gold Theme --- */
        :root {
            --color-primary: #00284D; /* Deep Blue */
            --color-accent: #DAA520; /* Goldenrod/Gold */
            --color-background: #f0f4f8; /* Light gray-blue background */
        }
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
        }
        
        /* Header Styling */
        .header-block {
            background-color: var(--color-primary);
            color: white;
            border-bottom: 5px solid var(--color-accent);
            border-radius: 0.75rem 0.75rem 0 0; /* Keep top corners rounded */
        }
        .header-block h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
        }
        .hammer-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
            color: var(--color-accent);
            text-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
        }

        /* Form Element Styling */
        .section-header {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
        }
        .input-field {
            border: 1px solid #c8d2e0; 
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            background-color: #ffffff;
            transition: all 0.2s ease-in-out;
        }
        .input-field:focus {
            border-color: var(--color-accent); 
            box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.3);
            outline: none;
        }
        .form-group label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
            display: block;
            line-height: 1.5;
        }

        /* Submit Button Styling */
        .btn-submit {
            background-color: var(--color-accent);
            color: var(--color-primary);
            font-weight: 700;
            border: 2px solid var(--color-accent);
            transition: background-color 0.3s, opacity 0.3s, transform 0.2s;
        }
        .btn-submit:hover {
            background-color: #e0b445;
            transform: scale(1.02);
        }
        .btn-submit:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Disclaimer/Message Box Styling */
        .disclaimer {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            padding: 1rem;
            border: 1px dashed var(--color-accent);
            border-radius: 0.5rem;
            background-color: #fcf8e3;
        }
        .message-box-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b988;
        }
        .message-box-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl">
        
        <!-- Header and Emblem (Updated Look) -->
        <header class="header-block text-center p-6 sm:p-8">
            <span class="hammer-icon">&#9874;</span>
            <h1 class="font-extrabold tracking-tight">APPLICATION FOR MEMBERSHIP</h1>
            <p class="text-xl mt-1 font-bold text-gray-200">King Hezekiah Lodge No. 1</p>
            <p class="text-sm mt-2 text-gray-400">A. F. & A. M. of Texas and the U. S. A.</p>
            <p class="text-xs text-gray-500 mt-1">Ancient Free and Accepted Scottish Rite / York Rite / Member of the General Grand Masonic Congress</p>
        </header>

        <div class="p-6 sm:p-10">
            <!-- Loading/Error Indicator -->
            <div id="statusMessage" class="text-center p-4 text-white font-medium bg-gray-600 rounded-lg mb-8">
                Initializing secure connection...
            </div>
            
            <!-- Detailed Error Display (Hidden by default) -->
            <div id="errorDisplay" class="hidden mb-8 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md">
                <p class="font-bold">Connection Error</p>
                <p id="errorText">Something went wrong.</p>
            </div>

            <!-- Main Form Container - Hidden by default until Auth succeeds -->
            <form id="membershipApplicationForm" class="space-y-10 hidden">
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Lodge Information</h2>
                    <div class="form-group">
                        <label for="lodgeName">IN Lodge Name</label>
                        <input type="text" id="lodgeName" name="lodgeName" placeholder="Name of Lodge" class="input-field" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="lodgeNumber">Lodge No.</label>
                            <input type="text" id="lodgeNumber" name="lodgeNumber" placeholder="Lodge Number" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="applicationDate">Date of Application given (Month/Day/Year)</label>
                            <input type="date" id="applicationDate" name="applicationDate" class="input-field" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group md:col-span-2">
                            <label for="lodgeAddress">Address</label>
                            <input type="text" id="lodgeAddress" name="lodgeAddress" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeCity">City</label>
                            <input type="text" id="lodgeCity" name="lodgeCity" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeCounty">County of</label>
                            <input type="text" id="lodgeCounty" name="lodgeCounty" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeState">State</label>
                            <input type="text" id="lodgeState" name="lodgeState" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="lodgeZip">Zip Code</label>
                            <input type="text" id="lodgeZip" name="lodgeZip" class="input-field">
                        </div>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Recommendations & Lodge Contact</h2>
                    <p class="font-semibold text-gray-700">Recommended By (Four Brother's Names and Addresses):</p>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec1Name" name="rec1Name" class="input-field" placeholder="Brother's Name 1" required>
                            <input type="text" id="rec1Address" name="rec1Address" class="input-field" placeholder="Address / City/State/ZIP 1" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec2Name" name="rec2Name" class="input-field" placeholder="Brother's Name 2" required>
                            <input type="text" id="rec2Address" name="rec2Address" class="input-field" placeholder="Address / City/State/ZIP 2" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec3Name" name="rec3Name" class="input-field" placeholder="Brother's Name 3" required>
                            <input type="text" id="rec3Address" name="rec3Address" class="input-field" placeholder="Address / City/State/ZIP 3" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="rec4Name" name="rec4Name" class="input-field" placeholder="Brother's Name 4" required>
                            <input type="text" id="rec4Address" name="rec4Address" class="input-field" placeholder="Address / City/State/ZIP 4" required>
                        </div>
                    </div>

                    <div class="space-y-4 pt-4 border-t border-gray-200">
                        <div class="form-group">
                            <label for="wmSecretaryName">Name of W.M. or Secretary</label>
                            <input type="text" id="wmSecretaryName" name="wmSecretaryName" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="wmSecretaryAddress">Address, City/State/ZIP</label>
                            <input type="text" id="wmSecretaryAddress" name="wmSecretaryAddress" class="input-field" placeholder="Address, City/State/ZIP">
                        </div>
                        <div class="form-group">
                            <label for="wmSecretaryPhone">Telephone No. (A/C)</label>
                            <input type="tel" id="wmSecretaryPhone" name="wmSecretaryPhone" class="input-field">
                        </div>
                    </div>
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Applicant Personal Details</h2>
                    <p class="disclaimer">All applicants to join the order shall be required to fill in the application and take a background check in their own handwriting, or cause the same to be done over their signature.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="printName">Applicant Name (PRINT OR TYPE NAME)</label>
                            <input type="text" id="printName" name="printName" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="ssn">Social Security No.</label>
                            <input type="text" id="ssn" name="ssn" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="age">Age last birthday</label>
                            <input type="number" id="age" name="age" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="dob">Date of Birth</label>
                            <input type="date" id="dob" name="dob" class="input-field">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="streetAddress">Street Address</label>
                        <input type="text" id="streetAddress" name="streetAddress" class="input-field">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="form-group">
                            <label for="applicantCity">City</label>
                            <input type="text" id="applicantCity" name="applicantCity" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="applicantState">State</label>
                            <input type="text" id="applicantState" name="applicantState" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="applicantZip">Zip Code</label>
                            <input type="text" id="applicantZip" name="applicantZip" class="input-field">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="applicantPhone">Telephone No. (A/C)</label>
                        <input type="tel" id="applicantPhone" name="applicantPhone" class="input-field">
                    </div>
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Marital and Family Status</h2>
                    <div class="form-group space-y-2">
                        <label>2. Marital Status</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="married" class="form-radio text-blue-600">
                                <span class="ml-2">Married</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="single" class="form-radio text-blue-600">
                                <span class="ml-2">Single</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="widowed" class="form-radio text-blue-600">
                                <span class="ml-2">Widowed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="maritalStatus" value="divorced" class="form-radio text-blue-600">
                                <span class="ml-2">Divorced</span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">(a) If Married:</h3>
                        <div class="form-group">
                            <label for="wifeName">Name of Wife</label>
                            <input type="text" id="wifeName" name="wifeName" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="marriageDetails">Date and place of marriage</label>
                            <input type="text" id="marriageDetails" name="marriageDetails" placeholder="Date and City/State" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="childrenMarried">Names and ages of all children born to this marriage:</label>
                            <textarea id="childrenMarried" name="childrenMarried" rows="2" class="input-field resize-none"></textarea>
                        </div>
                    </div>

                    <div class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-lg text-gray-700">(b) If married more than once:</h3>
                        
                        <div class="form-group space-y-2">
                            <label>State how said marriage terminated (Divorce or Death)</label>
                            <input type="text" id="priorMarriageTerminationDetails" name="priorMarriageTerminationDetails" class="input-field" placeholder="e.g., Divorce, Death">
                        </div>

                        <div class="form-group">
                            <label for="priorWifeChildren">Names and ages of all children born to this marriage:</label>
                            <textarea id="priorWifeChildren" name="priorWifeChildren" rows="2" class="input-field resize-none"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="deceasedWifeName">If terminated in death, Name of Deceased Wife</label>
                                <input type="text" id="deceasedWifeName" name="deceasedWifeName" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorcedWifeName">If terminated by divorce, name of Divorced wife</label>
                                <input type="text" id="divorcedWifeName" name="divorcedWifeName" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorceDate">Date Divorce granted</label>
                                <input type="date" id="divorceDate" name="divorceDate" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="divorceCityState">City, State of divorce</label>
                                <input type="text" id="divorceCityState" name="divorceCityState" class="input-field" placeholder="City, State">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="motherName">Name of Mother</label>
                            <input type="text" id="motherName" name="motherName" class="input-field">
                            <label class="inline-flex items-center mt-2">
                                <input type="checkbox" name="motherDeceased" value="true" class="form-checkbox text-red-600 rounded">
                                <span class="ml-2 text-sm text-red-700">Deceased (Check if applicable)</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="fatherName">Name of Father</label>
                            <input type="text" id="fatherName" name="fatherName" class="input-field">
                            <label class="inline-flex items-center mt-2">
                                <input type="checkbox" name="fatherDeceased" value="true" class="form-checkbox text-red-600 rounded">
                                <span class="ml-2 text-sm text-red-700">Deceased (Check if applicable)</span>
                            </label>
                        </div>
                        <div class="form-group md:col-span-2">
                            <label for="parentsAddress">Address (if living)</label>
                            <input type="text" id="parentsAddress" name="parentsAddress" placeholder="Address of Mother or Father" class="input-field">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="siblings">Names of all brothers and sisters of applicant born of same parents (list names/ages):</label>
                        <textarea id="siblings" name="siblings" rows="3" class="input-field resize-none"></textarea>
                    </div>

                    <div class="form-group border-t pt-4 border-gray-200">
                        <label for="beneficiaryName">Beneficiaryâ€™s Name and Relationship</label>
                        <input type="text" id="beneficiaryName" name="beneficiaryName" placeholder="Name - Relationship" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="beneficiaryAddress">Beneficiary's Address</label>
                        <input type="text" id="beneficiaryAddress" name="beneficiaryAddress" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="beneficiaryCityStateZip">City/State/Zip</label>
                        <input type="text" id="beneficiaryCityStateZip" name="beneficiaryCityStateZip" class="input-field">
                    </div>
                    
                </section>

                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Employment and Prior Membership</h2>
                    <div class="form-group">
                        <label for="occupation">Occupation</label>
                        <input type="text" id="occupation" name="occupation" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="employer">Name and address of employer</label>
                        <input type="text" id="employer" name="employer" class="input-field">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="employmentLength">How long in present employment?</label>
                            <input type="text" id="employmentLength" name="employmentLength" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="priorEmployer">Prior employer</label>
                            <input type="text" id="priorEmployer" name="priorEmployer" class="input-field">
                        </div>
                    </div>
                    <div class="form-group pt-4 border-t border-gray-200">
                        <label class="block mb-2">Have you ever made application to join a Masonic Lodge before?</label>
                        <div class="flex gap-4 mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="previousApplication" value="yes" class="form-radio text-blue-600">
                                <span class="ml-2">YES</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="previousApplication" value="no" class="form-radio text-blue-600">
                                <span class="ml-2">NO</span>
                            </label>
                        </div>
                        <div class="space-y-4 p-4 rounded-lg bg-gray-50">
                            <h3 class="font-semibold text-base text-gray-700">(a) If YES:</h3>
                            <div class="form-group">
                                <label for="priorLodgeName">Give name, City, State and Date of application</label>
                                <input type="text" id="priorLodgeName" name="priorLodgeName" placeholder="Name, City, State - Year" class="input-field">
                            </div>
                        </div>
                        <div class="space-y-4 p-4 rounded-lg bg-gray-50 mt-4">
                            <h3 class="font-semibold text-base text-gray-700">(b) If reinstating:</h3>
                            <div class="form-group">
                                <label for="reinstatingLodge">Name and No. of the Lodge where membership last held</label>
                                <input type="text" id="reinstatingLodge" name="reinstatingLodge" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="terminationDate">Date membership in said Lodge terminated</label>
                                <input type="date" id="terminationDate" name="terminationDate" class="input-field">
                            </div>
                            <div class="form-group">
                                <label for="terminationReason">Why Terminated</label>
                                <input type="text" id="terminationReason" name="terminationReason" class="input-field">
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Health and Conduct</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="healthStatus">Are you in good health?</label>
                            <select id="healthStatus" name="healthStatus" class="input-field appearance-none bg-white">
                                <option value="yes">YES</option>
                                <option value="no">NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="prescriptionTreatment">Has any physician prescribed treatment for you in last two years?</label>
                            <select id="prescriptionTreatment" name="prescriptionTreatment" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4 p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-base text-gray-700">If YES to prescribed treatment:</h3>
                        <div class="form-group">
                            <label for="physicianDetails">Name and address of physician</label>
                            <input type="text" id="physicianDetails" name="physicianDetails" class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="treatmentReason">For what treated?</label>
                            <input type="text" id="treatmentReason" name="treatmentReason" class="input-field">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="alcoholUse">Do you use alcoholic liquors to excess?</label>
                            <select id="alcoholUse" name="alcoholUse" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="drugUse">Narcotics or other drugs?</label>
                            <select id="drugUse" name="drugUse" class="input-field appearance-none bg-white">
                                <option value="no">NO</option>
                                <option value="yes">YES</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="convictedCrime">Have you ever been convicted of a crime or felony?</label>
                        <select id="convictedCrime" name="convictedCrime" class="input-field appearance-none bg-white">
                            <option value="no">NO</option>
                            <option value="yes">YES</option>
                        </select>
                    </div>
                </section>
                
                <section class="space-y-6">
                    <h2 class="text-xl font-bold section-header">Non-Masonic References</h2>
                    <p class="font-semibold text-gray-700">Please provide three non-Masonic references:</p>
                    <div class="space-y-4">
                        <div class="form-group">
                            <label for="reference1">1. Reference Name & Contact</label>
                            <input type="text" id="reference1" name="reference1" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="reference2">2. Reference Name & Contact</label>
                            <input type="text" id="reference2" name="reference2" class="input-field" required>
                        </div>
                        <div class="form-group">
                            <label for="reference3">3. Reference Name & Contact</label>
                            <input type="text" id="reference3" name="reference3" class="input-field" required>
                        </div>
                    </div>
                </section>

                <section class="space-y-6 pt-6 border-t border-gray-200">
                    <h2 class="text-xl font-bold section-header">Applicant Covenant</h2>
                    
                    <div class="disclaimer text-sm text-gray-600">
                        I certify and warrant the above answers to be true and correct, and agree that the same shall form a part of my application for membership... and I further covenant and agree that in the event any of my answers given above prove to be false or untrue, neither I, my beneficiary, heirs nor legal representatives shall ever assert any claim to the relief benefits provided for by the Order. And the liability of the Society shall be limited to refund of the relief assessments actually paid in by me.
                    </div>

                    <div class="form-group">
                        <label for="signatureApplicant">Signature of Applicant (Type full name to sign)</label>
                        <input type="text" id="signatureApplicant" name="signatureApplicant" class="input-field font-serif text-lg italic" required>
                    </div>
                </section>

                <!-- Submit Button -->
                <div class="flex flex-col items-center pt-8 gap-4">
                    <button type="submit" id="submitButton" class="w-full sm:w-1/2 px-8 py-4 rounded-lg shadow-xl btn-submit tracking-wider disabled:opacity-50" disabled>
                        Save & Submit Formal Application
                    </button>
                    <div id="spinner" class="hidden text-gray-700 font-bold">Processing...</div>
                </div>

                <!-- Submission Message Box -->
                <div id="messageBox" class="hidden mt-6 p-4 text-center text-sm rounded-lg" role="alert"></div>

            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // =========================================================================================
        // IMPORTANT: FIREBASE CONFIGURATION CHECK
        // If the environment variables are not available (i.e., you run this outside of the Canvas),
        // you MUST provide your configuration here.
        // =========================================================================================
        const YOUR_EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY_HERE",           
            authDomain: "YOUR_AUTH_DOMAIN_HERE",   
            projectId: "YOUR_PROJECT_ID_HERE",     
            storageBucket: "YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "YOUR_APP_ID_HERE"
        };
        // =========================================================================================


        // --- 1. CONFIGURATION HANDLING ---
        const isCanvasMode = typeof __firebase_config !== 'undefined' && __firebase_config.length > 0;
        
        let config;
        let authType = 'ANONYMOUS'; 
        let globalAppId = 'lodge-membership-app';

        if (isCanvasMode) {
            config = JSON.parse(__firebase_config);
            globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id';
            authType = 'CUSTOM_TOKEN';
        } else {
            config = YOUR_EXTERNAL_FIREBASE_CONFIG;
            globalAppId = config.projectId; 
            
            if (config.apiKey === "YOUR_API_KEY_HERE" || !config.projectId || config.projectId === "YOUR_PROJECT_ID_HERE") {
                 console.error("EXTERNAL RUN ERROR: Please update YOUR_EXTERNAL_FIREBASE_CONFIG with valid keys.");
                 config = null; 
            }
        }

        let db, auth;
        let userId = null;
        
        // UI Elements
        const form = document.getElementById('membershipApplicationForm');
        const statusMessage = document.getElementById('statusMessage');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorText = document.getElementById('errorText');
        const submitButton = document.getElementById('submitButton');
        const spinner = document.getElementById('spinner');
        const messageBox = document.getElementById('messageBox');

        /**
         * Initializes Firebase services and authentication.
         */
        async function initFirebase() {
            try {
                if (!config) {
                    throw new Error("Initialization blocked: Firebase configuration is missing or invalid in external mode.");
                }

                // 2. Initialize services
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);

                let userCredential;

                // 3. Authenticate based on environment
                if (authType === 'CUSTOM_TOKEN') {
                    // Canvas Mode: Use custom token
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (!initialAuthToken) {
                        userCredential = await signInAnonymously(auth); 
                    } else {
                        userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    }
                } else {
                    // External Mode: Use standard anonymous sign-in
                    userCredential = await signInAnonymously(auth);
                }

                if (userCredential && userCredential.user && userCredential.user.uid) {
                    userId = userCredential.user.uid;
                    console.log(`Application Form Authentication SUCCESS (${authType}). User ID: ${userId}`);
                    
                    // Success: Reveal the form and update status
                    statusMessage.textContent = `Connected successfully. Your Session ID: ${userId.substring(0, 8)}...`;
                    statusMessage.classList.remove('bg-gray-600');
                    statusMessage.classList.add('message-box-success');
                    
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                        form.classList.remove('hidden');
                        submitButton.disabled = false;
                    }, 500); 
                } else {
                    throw new Error("Authentication failed or returned no user.");
                }

            } catch (error) {
                console.error("Firebase Authentication/Initialization Error:", error);
                
                let friendlyError = error.message.includes('apiKey') 
                    ? "FATAL ERROR: Configuration is missing or invalid. Please check the code."
                    : error.message;

                statusMessage.classList.add('hidden');
                errorDisplay.classList.remove('hidden');
                errorText.textContent = friendlyError;
                errorDisplay.classList.add('message-box-error');
            }
        }
        
        /**
         * Validates the form before submission (Placeholder for deeper validation)
         */
        function validateForm() {
             // Rely on HTML5 required attributes for basic validation
            return form.checkValidity();
        }

        /**
         * Handles form submission
         */
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            messageBox.classList.add('hidden');
            if (!validateForm()) {
                messageBox.textContent = "Please fill out all required fields.";
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-error block";
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            spinner.classList.remove('hidden');

            try {
                // 2. Collect Data
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                
                // Add System Metadata
                data.applicantId = userId;
                data.submissionDate = serverTimestamp();
                data.appId = globalAppId; 
                data.status = 'Pending Review'; // Initial status

                // 3. Save to Firestore
                // Path: /artifacts/{appId}/public/data/applications
                const collectionPath = `/artifacts/${globalAppId}/public/data/applications`;
                const collectionRef = collection(db, collectionPath);
                
                await addDoc(collectionRef, data);

                // 4. Success Message
                messageBox.textContent = 'Success! Your application has been submitted and saved to the database for review. Thank you.';
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-success block";
                form.reset();
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (e) {
                console.error("Error adding document: ", e);
                messageBox.textContent = `Submission failed: ${e.message}. Please check console for network/permission errors.`;
                messageBox.className = "mt-6 p-4 text-center text-sm rounded-lg message-box-error block";
            } finally {
                submitButton.textContent = 'Save & Submit Formal Application';
                submitButton.disabled = false;
                spinner.classList.add('hidden');
            }
        });

        // Start App
        initFirebase();
    </script>
</body>
</html>

